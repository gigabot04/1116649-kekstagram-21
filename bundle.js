(()=>{"use strict";(()=>{let e;window.helpersModule={debounce:(t,o=500)=>{e&&window.clearTimeout(e),e=window.setTimeout(t,o)}}})(),(()=>{const e=document.querySelector(".pictures"),t=document.querySelectorAll(".img-filters__button"),o=document.querySelector("#filter-random"),n=document.querySelector("#filter-discussed"),r=t=>{for(;document.querySelector(".picture");)document.querySelector(".picture").remove();const o=document.createDocumentFragment();t.forEach((e=>{o.appendChild(window.galleryModule.renderPhoto(e))})),e.appendChild(o)};let c=[];const d=e=>{let t=e;o.classList.contains("img-filters__button--active")?t=[...e].sort((()=>Math.random()-.5)).slice(0,10):n.classList.contains("img-filters__button--active")&&(t=[...c].sort(((e,t)=>t.comments.length-e.comments.length))),r(t)};for(let e of t)e.addEventListener("click",(()=>{document.querySelector(".img-filters__button--active").classList.remove("img-filters__button--active"),e.classList.add("img-filters__button--active"),window.helpersModule.debounce((()=>d(c)))}));window.filtersModule={filteredPictures:d,createPictures:r,successLoad:e=>{c=e,window.filtersModule.filteredPictures(c),document.querySelector(".img-filters").classList.remove("img-filters--inactive")}}})(),(()=>{const e=new XMLHttpRequest;window.backend={load:(t,o)=>{e.responseType="json",e.open("GET","https://21.javascript.pages.academy/kekstagram/data"),e.addEventListener("load",(()=>{const n="";switch(e.status){case 200:t(e.response);break;case 400:n="Неверный запрос";break;case 401:n="Пользователь не авторизован";break;case 404:n="Ничего не найдено";break;default:n=`Cтатус ответа: : ${e.status} ${e.statusText}`}n&&o(n)})),e.addEventListener("error",(()=>{o("Произошла ошибка соединения")})),e.addEventListener("timeout",(()=>{o(`Запрос не успел выполниться за ${e.timeout} мс`)})),e.timeout=1e4,e.send()},upload:(t,o,n)=>{e.responseType="json",e.addEventListener("load",(()=>{o(e.response)})),e.addEventListener("error",(()=>{n()})),e.addEventListener("timeout",(()=>{n()})),e.timeout=1e4,e.open("POST","https://21.javascript.pages.academy/kekstagram/"),e.send(t)}}})(),(()=>{const e=document.querySelector(".img-upload__preview img"),t=document.querySelector(".img-upload__overlay"),o=document.querySelector(".img-upload__cancel"),n=document.querySelector(".scale__control--smaller"),r=document.querySelector(".scale__control--bigger"),c=document.querySelector(".scale__control--value");let d,s=100;const l=e=>{"Escape"===e.key&&(e.preventDefault(),i())},i=()=>{t.classList.add("hidden"),document.querySelector("body").classList.remove("modal-open"),document.removeEventListener("keydown",l),document.querySelector(".img-upload__preview img").removeAttribute("style",""),document.querySelector(".img-upload__preview img").removeAttribute("class",""),s=100,d&&(d.value="")};o.addEventListener("click",(()=>{i()})),n.addEventListener("click",(t=>{t.preventDefault(),s>25&&(s-=25,c.value=s+"%",e.style.transform=`scale(${s/100})`)})),r.addEventListener("click",(t=>{t.preventDefault(),s<100&&(s+=25,c.value=s+"%",e.style.transform=`scale(${s/100})`)})),window.pictureModule={uploadFile:o=>{if(d=o.target,t.classList.remove("hidden"),document.querySelector("body").classList.add("modal-open"),document.addEventListener("keydown",l),window.formModule.init(e,l),d.files&&d.files[0]){const t=new FileReader;t.addEventListener("load",(t=>{e.setAttribute("src",t.target.result)})),t.readAsDataURL(d.files[0])}},photoEditClose:i,onPhotoEditEscPress:l}})(),(()=>{const e=document.querySelector(".big-picture__img").querySelector("img"),t=document.querySelector(".likes-count"),o=document.querySelector(".comments-count"),n=document.querySelector(".social__caption"),r=document.querySelector(".social__comments"),c=document.querySelector("#comment").content,d=document.querySelector(".big-picture"),s=document.querySelector(".big-picture__cancel"),l=e=>{const t=document.createDocumentFragment();return e.forEach((e=>{const o=c.cloneNode(!0);o.querySelector(".social__picture").src=e.avatar,o.querySelector(".social__picture").alt=e.name,o.querySelector(".social__text").textContent=e.message,t.appendChild(o)})),t},i=e=>{"Escape"===e.key&&(e.preventDefault(),d.classList.add("hidden"),document.querySelector("body").classList.remove("modal-open"))},u=[],a=[],m=document.querySelector(".comments-loader"),v=document.querySelector(".social__comment-count"),p=()=>{d.classList.add("hidden"),document.querySelector("body").classList.remove("modal-open"),document.removeEventListener("keydown",i),u.length=0,a.length=0,m.removeEventListener("click",y),s.removeEventListener("click",p)},y=()=>{r.appendChild(l(a.splice(0,5))),0===a.length&&(m.classList.add("hidden"),v.classList.add("hidden"))};window.previewModule={openPicture:c=>{for(u.push(...c.comments),a.push(...u.splice(5,u.length)),m.classList.remove("hidden"),v.classList.remove("hidden"),e.src=c.url,t.textContent=c.likes,o.textContent=c.comments.length,n.textContent=c.description,m.addEventListener("click",y);r.firstChild;)r.removeChild(r.firstChild);r.appendChild(l(u)),d.classList.remove("hidden"),document.querySelector("body").classList.add("modal-open"),document.addEventListener("keydown",i),s.addEventListener("click",p)}}})(),(()=>{const e=document.querySelector(".text__description"),t=document.querySelectorAll(".effects__item"),o=document.querySelector(".img-upload__form"),n=document.querySelector(".effect-level__pin"),r=document.querySelector(".effect-level__value"),c=document.querySelector(".effect-level__depth"),d=/^#[a-zA-Zа-яА-ЯЁё0-9]*$/,s=document.querySelector(".img-upload__submit"),l=document.querySelector(".text__hashtags"),i={sepia:e=>`sepia(${e/100})`,chrome:e=>`grayscale(${e/100})`,marvin:e=>`invert(${e}%)`,phobos:e=>`blur(${3*e/100}px)`,heat:e=>`brightness(${2*e/100+1})`,none:()=>""},u=(e,t,o)=>o.indexOf(e)!==t;window.formModule={init:(a,m)=>{const v=document.querySelectorAll(".effects__item"),p=document.querySelector(".img-upload__effect-level"),y=e=>{e.preventDefault();const t=document.querySelector(".effects__radio:checked").value;let o=e.clientX;const d=e=>{e.preventDefault();let d=o-e.clientX;o=e.clientX;let s=(n.offsetLeft-d)/4.53;n.style.left=s+"%",c.style.width=s+"%",a.style.filter=i[t](s),r.value=parseInt(s,10),n.offsetLeft<=0?(n.style.left="0%",c.style.width="0%"):n.offsetLeft>=453&&(n.style.left="100%",c.style.width="100%")},s=e=>{e.preventDefault(),document.removeEventListener("mousemove",d),document.removeEventListener("mouseup",s)};document.addEventListener("mousemove",d),document.addEventListener("mouseup",s)};p.classList.add("hidden");for(let e of v)e.addEventListener("click",(()=>{e.querySelector("#effect-none")?p.classList.add("hidden"):p.classList.remove("hidden")}));for(let e of t)e.addEventListener("click",(()=>{const t=e.querySelector(".effects__preview").classList[1];a.className="",a.classList.add(t),a.style.filter="",n.style.left="100%",c.style.width="100%"}));n.addEventListener("mousedown",y),e.addEventListener("focus",(()=>{document.removeEventListener("keydown",m)})),e.addEventListener("blur",(()=>{document.addEventListener("keydown",m)})),l.addEventListener("focus",(()=>{document.removeEventListener("keydown",m)})),l.addEventListener("blur",(()=>{document.addEventListener("keydown",m)}));const f=()=>{const e=l.value.split(" ");let t=!0;for(let n=0;n<e.length;n++)e[n]=e[n].toUpperCase(),""!==l.value&&(!("#"!==(o=e[n])&&d.test(o)&&o.length>2&&o.length<=20)||e.some(u)||e.length>5)&&(t=!1);var o;t?l.setCustomValidity(""):(l.setCustomValidity("Есть неправильные или повторяющиеся хеш-теги"),l.reportValidity())};s.addEventListener("click",f);const _=e=>{"Escape"===e.key&&(e.preventDefault(),document.querySelector(".error").remove())},L=e=>{"Escape"===e.key&&(e.preventDefault(),document.querySelector(".success").remove())},w=e=>{e.preventDefault(),n.removeEventListener("mousedown",y),document.removeEventListener("keydown",window.pictureModule.onPhotoEditEscPress),o.removeEventListener("submit",w),window.backend.upload(new FormData(o),(()=>{o.reset(),window.pictureModule.photoEditClose(),(()=>{const e=document.createDocumentFragment(),t=document.querySelector("#success").content.cloneNode(!0);e.appendChild(t),document.querySelector("main").appendChild(e),document.addEventListener("keydown",L),document.querySelector(".success__button").addEventListener("click",(()=>{document.removeEventListener("keydown",L),document.querySelector(".success").remove()}))})(),s.removeEventListener("click",f),document.querySelector(".img-upload__preview img").removeAttribute("style",""),document.querySelector(".img-upload__preview img").removeAttribute("class","")}),(()=>{window.pictureModule.photoEditClose(),(()=>{const e=document.createDocumentFragment(),t=document.querySelector("#error").content.cloneNode(!0);e.appendChild(t),document.querySelector("main").appendChild(e),document.addEventListener("keydown",_),document.querySelector(".error__button").addEventListener("click",(()=>{document.removeEventListener("keydown",_),document.querySelector(".error").remove()}))})()}))};o.addEventListener("submit",w)},uploadError:e=>{const t=document.createElement("div");t.style="z-index: 100; margin: 0 auto; text-align: center; background-color: red;",t.style.position="absolute",t.style.left=0,t.style.right=0,t.style.fontSize="30px",t.textContent=e,document.body.insertAdjacentElement("afterbegin",t)}}})(),(()=>{const e=document.querySelector("#picture").content.querySelector(".picture");window.galleryModule={renderPhoto:t=>{const o=e.cloneNode(!0);return o.querySelector(".picture__img").src=t.url,o.querySelector(".picture__likes").textContent=t.likes,o.querySelector(".picture__comments").textContent=t.comments.length,o.addEventListener("click",(()=>{window.previewModule.openPicture(t)})),o}}})(),(()=>{const e=document.querySelector("#upload-file");window.backend.load(window.filtersModule.successLoad,window.formModule.uploadError),e.addEventListener("change",window.pictureModule.uploadFile)})()})();